# Django Stripe Store

A Django e-commerce application with Stripe payment integration (test mode) that allows users to purchase products and view their order history on a single page.

**GitHub Repository**: https://github.com/utkarshm18/Django-Stripe-Store.git

## Assumptions

1. **Single Page UX**: All functionality (product display, checkout, order history) is on one page for simplicity and better UX flow.
2. **Stripe Checkout**: Using Stripe Checkout (hosted payment page) instead of Payment Intents because:
   - Simpler implementation
   - Built-in PCI compliance
   - Better mobile experience
   - Less code to maintain
3. **User Authentication**: Users can register and login to track their orders. Orders are linked to user accounts. Anonymous users can still browse but won't see order history.
4. **Fixed Products**: Three products are seeded via management command. Products can be managed via Django admin.
5. **PostgreSQL**: Using PostgreSQL as specified, but the app can work with SQLite for development if needed.

## Flow Chosen: Stripe Checkout

**Why Stripe Checkout over Payment Intents?**

- **Simplicity**: Checkout handles the entire payment UI, reducing frontend complexity
- **Security**: Stripe handles all sensitive payment data (PCI compliance)
- **Mobile-friendly**: Responsive payment form out of the box
- **Less code**: No need to build custom payment forms or handle card validation
- **Better UX**: Professional, tested payment experience

**Flow:**
1. User selects products and quantities on the main page
2. Clicks "Buy Now" button
3. Frontend sends AJAX request to create checkout session
4. Backend creates order in database (pending status) with idempotency key
5. Backend creates Stripe Checkout session
6. User is redirected to Stripe's hosted checkout page
7. After payment, Stripe redirects back to success page
8. Success page verifies payment and updates order status
9. User is redirected back to main page to see their order

## Double Charge / Inconsistent State Prevention

Multiple layers of protection:

1. **Idempotency Keys**: Each checkout session creation uses a unique UUID as an idempotency key stored in the database. If the same key is used, the existing order/session is returned.

2. **Database Transactions**: Order creation and Stripe session creation are wrapped in atomic transactions to ensure consistency.

3. **Order Status Checks**: Before updating an order to "paid", the system checks if it's still in "pending" status to prevent race conditions.

4. **Frontend Protection**: 
   - Button is disabled during processing
   - Loading overlay prevents multiple clicks
   - `isProcessing` flag prevents concurrent requests

5. **Stripe Session Uniqueness**: `stripe_session_id` is stored as unique in the database, preventing duplicate sessions.

6. **Webhook Support**: Webhook endpoint is included (optional) to handle async payment confirmations from Stripe for additional reliability.

## Setup & Run Steps

### Prerequisites

- Python 3.8+
- PostgreSQL 12+
- Stripe account (test mode)

### Installation

1. **Clone the repository**
   ```bash
   git clone https://github.com/utkarshm18/Django-Stripe-Store.git
   cd Django-Stripe-Store
   ```

2. **Create virtual environment**
   ```bash
   python -m venv venv
   # Windows
   venv\Scripts\activate
   # Linux/Mac
   source venv/bin/activate
   ```

3. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

4. **Set up environment variables**
   
   **Option A: Use the setup script (Recommended)**
   ```bash
   python setup_env.py
   ```
   This will guide you through creating the `.env` file.
   
   **Option B: Manual setup**
   
   Create a `.env` file in the project root with the following variables:
   ```bash
   # Copy .env.example to .env and fill in your values
   cp .env.example .env
   ```
   
   Required environment variables (see `.env.example` for template):
   - `SECRET_KEY`: Django secret key (auto-generated by setup script)
   - `DB_NAME`: PostgreSQL database name (default: stripe_db)
   - `DB_USER`: PostgreSQL username (default: postgres)
   - `DB_PASSWORD`: PostgreSQL password (default: utkarsh18)
   - `DB_HOST`: Database host (default: localhost)
   - `DB_PORT`: Database port (default: 5432)
   - `STRIPE_PUBLISHABLE_KEY`: Stripe publishable key (pk_test_...)
   - `STRIPE_SECRET_KEY`: Stripe secret key (sk_test_...)
   - `STRIPE_WEBHOOK_SECRET`: Stripe webhook secret (optional, for webhook verification)
   
   **ðŸ“– See `STRIPE_SETUP.md` for step-by-step instructions on getting Stripe keys**

5. **Set up PostgreSQL database**
   ```bash
   # Create database
   createdb stripe_db
   # Or using psql:
   # psql -U postgres
   # CREATE DATABASE stripe_db;
   ```

6. **Run migrations**
   ```bash
   python manage.py migrate
   ```

7. **Create superuser (optional, for admin access)**
   ```bash
   python manage.py createsuperuser
   ```

8. **Seed products**
   ```bash
   python manage.py seed_products
   ```

9. **Run development server**
   ```bash
   python manage.py runserver
   ```

12. **Access the application**
    - Main page: http://127.0.0.1:8000/
    - Register: http://127.0.0.1:8000/register/
    - Login: http://127.0.0.1:8000/login/
    - Admin panel: http://127.0.0.1:8000/admin/

### Docker Setup (Alternative)

1. **Create `.env` file** with your Stripe keys (see step 4 above)

2. **Run with Docker Compose**
   ```bash
   docker-compose up --build
   ```

3. **Access the application**
   - Main page: http://127.0.0.1:8000/
   - Admin panel: http://127.0.0.1:8000/admin/

The Docker setup automatically:
- Sets up PostgreSQL database
- Runs migrations
- Seeds products
- Starts the Django server

### Stripe Webhook Setup (Optional but Recommended)

For production or better reliability, set up webhooks:

1. Install Stripe CLI: https://stripe.com/docs/stripe-cli
2. Login: `stripe login`
3. Forward webhooks: `stripe listen --forward-to localhost:8000/webhook/`
4. Copy the webhook signing secret to `.env` as `STRIPE_WEBHOOK_SECRET`

## Code Quality & Logic Notes

### Architecture

- **Models**: Clean separation with `Product`, `Order`, and `OrderItem` models
- **Views**: RESTful design with clear separation of concerns
- **Templates**: Single-page design with Bootstrap 5 for responsive UI
- **Security**: CSRF protection, input validation, SQL injection prevention (Django ORM)

### Key Features

1. **Idempotency**: Every checkout session creation is idempotent via unique keys
2. **Error Handling**: Comprehensive error handling in views with user-friendly messages
3. **Validation**: Server-side validation of quantities and product existence
4. **Atomic Operations**: Database transactions ensure data consistency
5. **Status Management**: Clear order status workflow (pending â†’ paid/failed)

### Testing Recommendations

- Test with Stripe test cards: https://stripe.com/docs/testing
- Test double-click scenarios
- Test network failures during checkout
- Test webhook delivery
- Test with invalid product IDs/quantities

### Production Considerations

- Set `DEBUG=False` and configure `ALLOWED_HOSTS`
- Use environment-specific settings
- Set up proper logging
- Configure static files serving (e.g., WhiteNoise or CDN)
- Enable HTTPS (required for Stripe)
- Set up proper error monitoring (e.g., Sentry)
- Add user authentication
- Implement rate limiting
- Add database backups

## Project Structure

```
Django Stripe Assign/
â”œâ”€â”€ manage.py
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env.example
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ AI-assist.md
â”œâ”€â”€ stripe_app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ settings.py
â”‚   â”œâ”€â”€ urls.py
â”‚   â”œâ”€â”€ wsgi.py
â”‚   â””â”€â”€ asgi.py
â””â”€â”€ store/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ models.py
    â”œâ”€â”€ views.py
    â”œâ”€â”€ urls.py
    â”œâ”€â”€ admin.py
    â”œâ”€â”€ apps.py
    â”œâ”€â”€ migrations/
    â”œâ”€â”€ management/
    â”‚   â””â”€â”€ commands/
    â”‚       â””â”€â”€ seed_products.py
    â””â”€â”€ templates/
        â””â”€â”€ store/
            â””â”€â”€ home.html
```

