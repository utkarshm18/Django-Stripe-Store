<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django Stripe Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .product-card {
            transition: transform 0.2s;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .quantity-input {
            max-width: 100px;
        }
        .order-card {
            border-left: 4px solid #28a745;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .loading-overlay.show {
            display: flex;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-cart-check"></i> Django Stripe Store
            </span>
            <div class="navbar-nav flex-row">
                {% if user.is_authenticated %}
                    <span class="navbar-text me-3">
                        <i class="bi bi-person-circle"></i> Welcome, {{ user.username }}!
                    </span>
                    <a class="nav-link me-2" href="{% url 'logout' %}">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                {% else %}
                    <a class="nav-link me-2" href="{% url 'login' %}">
                        <i class="bi bi-box-arrow-in-right"></i> Login
                    </a>
                    <a class="nav-link" href="{% url 'register' %}">
                        <i class="bi bi-person-plus"></i> Register
                    </a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Django Messages -->
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
        
        <!-- Success Message -->
        {% if payment_success and success_order %}
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert" style="border-left: 4px solid #28a745;">
            <div class="d-flex align-items-start">
                <i class="bi bi-check-circle-fill fs-3 me-3 text-success"></i>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-2">
                        <i class="bi bi-check-circle"></i> Payment Successful!
                    </h5>
                    <p class="mb-2">
                        <strong>Order #{{ success_order.id }}</strong> has been confirmed. Thank you for your purchase!
                    </p>
                    <div class="mb-2">
                        <strong>Items Purchased:</strong>
                        <ul class="mb-0 mt-1">
                            {% for item in success_order.items.all %}
                            <li>
                                <strong>{{ item.quantity }}x</strong> {{ item.product.name }} 
                                @ ₹<strong>{{ item.price|default:item.product.price }}</strong> each
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <p class="mb-0">
                        <strong>Total Amount: ₹{{ success_order.total_amount|default:"0.00" }}</strong>
                    </p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
        {% elif payment_success %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> <strong>Payment Successful!</strong> Your order #{{ order_id }} has been confirmed. Thank you for your purchase!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
        
        <!-- Products Section -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="mb-4"><i class="bi bi-box-seam"></i> Products</h2>
            </div>
            {% for product in products %}
            <div class="col-md-4 mb-4">
                <div class="card product-card shadow-sm">
                    {% if product.image_url %}
                    <img src="{{ product.image_url }}" class="card-img-top" alt="{{ product.name }}" style="height: 200px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="bi bi-image text-white" style="font-size: 3rem;"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text">{{ product.description }}</p>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="h4 text-primary mb-0">₹{{ product.price }}</span>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Quantity</span>
                            <input type="number" 
                                   class="form-control quantity-input" 
                                   id="qty-{{ product.id }}" 
                                   min="1" 
                                   value="1"
                                   data-product-id="{{ product.id }}"
                                   data-product-price="{{ product.price }}">
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="alert alert-info">No products available. Please add products in the admin panel.</div>
            </div>
            {% endfor %}
        </div>

        <!-- Buy Button -->
        <div class="row mb-5">
            <div class="col-12 text-center">
                <button id="buy-btn" class="btn btn-primary btn-lg px-5">
                    <i class="bi bi-credit-card"></i> Buy Now
                </button>
            </div>
        </div>

        <!-- My Orders Section -->
        <div class="row" id="orders-section">
            <div class="col-12">
                <h2 class="mb-4"><i class="bi bi-receipt"></i> My Orders</h2>
                {% if not user.is_authenticated %}
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> <a href="{% url 'login' %}">Login</a> or <a href="{% url 'register' %}">Register</a> to see your order history.
                </div>
                {% endif %}
                {% if orders %}
                    {% for order in orders %}
                    <div class="card order-card mb-3 shadow-sm {% if payment_success and order_id == order.id|stringformat:'s' %}border-success border-2{% endif %}" id="order-{{ order.id }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">Order #{{ order.id }}</h5>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-calendar"></i> {{ order.created_at|date:"F d, Y g:i A" }}
                                    </p>
                                    <div class="mb-2">
                                        <strong>Items:</strong>
                                        <ul class="mb-0">
                                            {% for item in order.items.all %}
                                            <li>{{ item.quantity }}x {{ item.product.name }} @ ₹{{ item.price|default:item.product.price }} each</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success fs-6 mb-2">{{ order.status|upper }}</span>
                                    <div class="h5 text-primary mb-0">₹{{ order.total_amount|default:"0.00" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No orders yet. Place an order to see it here!
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    {% csrf_token %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Check if Stripe key is configured
        const stripePublishableKey = '{{ stripe_publishable_key }}';
        if (!stripePublishableKey || stripePublishableKey === '' || stripePublishableKey.includes('your_')) {
            alert('ERROR: Stripe keys not configured!\n\nPlease:\n1. Create a .env file in your project root\n2. Add your Stripe test keys\n3. See STRIPE_SETUP.md for instructions\n\nGet keys from: https://dashboard.stripe.com/test/apikeys');
            console.error('Stripe publishable key is missing or not configured');
        }
        
        const stripe = stripePublishableKey ? Stripe(stripePublishableKey) : null;
        const buyBtn = document.getElementById('buy-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        let isProcessing = false;
        
        // Scroll to orders section if payment was successful
        {% if payment_success and success_order %}
        window.addEventListener('load', function() {
            // Wait a bit for the page to render, then scroll
            setTimeout(function() {
                const ordersSection = document.getElementById('orders-section');
                if (ordersSection) {
                    // Scroll to orders section
                    ordersSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Highlight the new order
                    const newOrder = document.getElementById('order-{{ success_order.id }}');
                    if (newOrder) {
                        // Add highlight animation
                        newOrder.style.transition = 'all 0.3s ease';
                        newOrder.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.5)';
                        
                        // Remove highlight after animation
                        setTimeout(function() {
                            newOrder.style.boxShadow = '';
                        }, 3000);
                    }
                }
            }, 800);
        });
        {% endif %}
        
        // Add pulse animation for new orders
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
                50% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            }
        `;
        document.head.appendChild(style);
        
        // Get CSRF token from cookie or meta tag
        function getCSRFToken() {
            const token = getCookie('csrftoken');
            if (token) return token;
            // Fallback: try to get from meta tag if csrf_token was rendered
            const metaTag = document.querySelector('meta[name=csrf-token]');
            if (metaTag) return metaTag.getAttribute('content');
            // Fallback: try to get from hidden input
            const input = document.querySelector('input[name=csrfmiddlewaretoken]');
            if (input) return input.value;
            return null;
        }

        // Generate and store idempotency key in sessionStorage to prevent double-submit
        function getIdempotencyKey() {
            let key = sessionStorage.getItem('checkout_idempotency_key');
            if (!key) {
                key = 'idemp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('checkout_idempotency_key', key);
            }
            return key;
        }
        
        // Clear idempotency key after successful redirect
        function clearIdempotencyKey() {
            sessionStorage.removeItem('checkout_idempotency_key');
        }

        buyBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (isProcessing) {
                console.log('Request already in progress, ignoring click');
                return; // Prevent double clicks
            }
            
            // Check if Stripe is configured
            if (!stripe) {
                alert('Stripe is not configured. Please set up your Stripe keys in the .env file.\n\nSee STRIPE_SETUP.md for instructions.');
                return;
            }

            // Collect items with quantities > 0
            const items = [];
            const quantityInputs = document.querySelectorAll('.quantity-input');
            
            quantityInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    items.push({
                        product_id: input.dataset.productId,
                        quantity: quantity
                    });
                }
            });

            if (items.length === 0) {
                alert('Please select at least one item with quantity > 0');
                return;
            }

            // Show loading overlay and disable button IMMEDIATELY
            isProcessing = true;
            loadingOverlay.classList.add('show');
            buyBtn.disabled = true;
            buyBtn.style.pointerEvents = 'none';
            buyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            
            // Disable all quantity inputs to prevent changes during processing
            quantityInputs.forEach(input => {
                input.disabled = true;
            });

            try {
                const csrfToken = getCSRFToken();
                if (!csrfToken) {
                    throw new Error('CSRF token not found');
                }
                
                // Get or generate idempotency key
                const idempotencyKey = getIdempotencyKey();
                
                const response = await fetch('/create-checkout-session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ 
                        items: items,
                        idempotency_key: idempotencyKey
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create checkout session');
                }

                // Check if this is an existing session (duplicate prevention)
                if (data.existing) {
                    console.log('Using existing checkout session (duplicate request prevented)');
                }
                
                // Clear idempotency key before redirect (will be set again if user comes back)
                clearIdempotencyKey();

                // Redirect to Stripe Checkout
                const result = await stripe.redirectToCheckout({
                    sessionId: data.sessionId
                });

                if (result.error) {
                    throw new Error(result.error.message);
                }
                
                // If redirect doesn't happen immediately, keep button disabled
                // (redirect should happen, but this is a safety measure)
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Error: ' + error.message);
                // Reset button state on error
                isProcessing = false;
                loadingOverlay.classList.remove('show');
                buyBtn.disabled = false;
                buyBtn.style.pointerEvents = 'auto';
                buyBtn.innerHTML = '<i class="bi bi-credit-card"></i> Buy Now';
                
                // Re-enable quantity inputs
                quantityInputs.forEach(input => {
                    input.disabled = false;
                });
            }
        });
        
        // Prevent form submission on Enter key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && isProcessing) {
                e.preventDefault();
                return false;
            }
        });
        
        // Note: beforeunload warning removed per user request
        // The isProcessing flag and other protections still prevent double-submit

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>

